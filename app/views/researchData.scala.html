@* Copyright 2016 Jan Schnasse, hbz. Licensed under the GNU Affero General Public License *@ 

@(myForm:Form[models.ZettelModel],dataFormat:String,documentId:String,topicId:String,formType:String)
@import tags._ 
@import services._
@jsonMap=@{ZettelHelper.getJsonMap(myForm)}
@import controllers.ZettelController.callDataStreamEndpoint



@zettel("Forschungsdaten",myForm,dataFormat,documentId,topicId,formType) {
	@if(myForm.hasGlobalErrors) {
		<p class="error">@myForm.globalError.message</p>
	} 
	@helper.form(action = routes.ZettelController.postForm(ResearchData.id,dataFormat,documentId,topicId)){
		
		<a href="@models.ResearchData.getHelpTextUrl()" id="helpTextUrl" style="float:right" target="blank">Hilfe</a>
		@accordion(""){
			@accordionPanel(services.ZettelFields.titleHeaderZF.getLabel(),"title-section"){
			    @smallTextArea(myForm,"title","Titel"+"*","",1)
				<br/>
				@smallTextArea(myForm,"alternative","Alternativer Titel","",2)
		}

			@accordionPanel(services.ZettelFields.creatorshipHeaderZF.getLabel(),"creator-section"){
                @multifieldLd(myForm,jsonMap,"creator",services.ZettelFields.creatorZF.getLabel(),"search",3,ArticleHelper.getPersonLookupEndpoints())
			    <br/>
				@multifieldLd(myForm,jsonMap,"contributor",services.ZettelFields.contributorZF.getLabel(),"search",4,ArticleHelper.getPersonLookupEndpoints())
				<br/>
			    @multifieldLd(myForm,jsonMap,"other",services.ZettelFields.otherZF.getLabel(),"search",5,ArticleHelper.getPersonLookupEndpoints())		    
			}
			@accordionPanel(services.ZettelFields.resourceHeaderZF.getLabel(),"upload-section"){
				@singlefieldText(myForm,"issued",services.ZettelFields.issuedZF.getLabel()+"*","",12)
			}
			@accordionPanel(services.ZettelFields.collectionHeaderZF.getLabel(),"collection-section"){
				@multifieldLd(myForm,jsonMap,"institution",services.ZettelFields.institutionZF.getLabel(),"search",13,ArticleHelper.getInstitutionLookupEndpoints())
			}
			@accordionPanel(services.ZettelFields.uploadHeaderZF.getLabel(),"upload-section"){
				@singleSelect(myForm,"medium",services.ZettelFields.mediumZF.getLabel(),"select-medium",ResearchDataHelper.getMediumMap(),6)
				<br/>
				@singleSelect(myForm,"yearOfCopyright",services.ZettelFields.yearOfCopyrightZF.getLabel(),"datepicker-year",ResearchDataHelper.getCopyrightYear(),7)
				<br />
				@singleSelect(myForm,"license",services.ZettelFields.licenseZF.getLabel(),"select-license",ResearchDataHelper.getLicenseMap(),8)
				<br />
				@datepicker(myForm,"embargoTime",services.ZettelFields.embargoTimeZF.getLabel(),"datepicker",9)
			}
			@accordionPanel(services.ZettelFields.catalogingHeaderZF.getLabel(),"cataloging-section"){
				@singleSelect(myForm,"language",services.ZettelFields.languageZF.getLabel(),"select-language",ResearchDataHelper.getLanguageMap(),10)
				<br/>
				@textArea(myForm,"description",services.ZettelFields.descriptionZF.getLabel(),"",11)
				<br />
				@textArea(myForm,"usageManual",services.ZettelFields.usageManualZF.getLabel(),"",12)
				<br />
				@multicombobox(myForm,jsonMap,"ddc",services.ZettelFields.ddcZF.getLabel()+"*","select-ddc",ArticleHelper.ddc,13)
				<br />
				@multifieldLd(myForm,jsonMap,"subject",services.ZettelFields.subjectZF.getLabel(),"search",14,ArticleHelper.getSubjectLookupEndpoints())			
			}
			@accordionPanel(services.ZettelFields.fundingsHeaderZF.getLabel(),"identifier-section"){
                @funderEditingWidget(myForm,jsonMap)
            }
			@accordionPanel(services.ZettelFields.observationHeaderZF.getLabel(),"recording-section"){
				@multiselect(myForm,jsonMap,"dataOrigin",services.ZettelFields.dataOriginZF.getLabel(),"select-dataOrigin",ResearchDataHelper.getDataOriginMap(),15)
				<br />
				@textArea(myForm,"recordingPeriod",services.ZettelFields.recordingPeriodZF.getLabel(),"",16)
				<br />
				@multifieldLd(myForm,jsonMap,"recordingLocation",services.ZettelFields.recordingLocationZF.getLabel(),"geonames-lookup",17,ResearchDataHelper.getEmptyLookupEndpoints())
				<br />
				@multifieldLd(myForm,jsonMap,"recordingCoordinates",services.ZettelFields.recordingCoordinatesZF.getLabel(),"geonames-reverse-lookup",18,ResearchDataHelper.getEmptyLookupEndpoints())
			}
			@accordionPanel(services.ZettelFields.publicationsHeaderZF.getLabel(),"link-section"){
			    @multifieldText(myForm,jsonMap,"reference",services.ZettelFields.referenceZF.getLabel(),"",19)
				<br />
				@multifieldText(myForm,jsonMap,"associatedPublication",services.ZettelFields.associatedPublicationZF.getLabel(),"",20)
				<br/>
				@multifieldText(myForm,jsonMap,"associatedDataset",services.ZettelFields.associatedDatasetZF.getLabel(),"",21)
				<br/>
				@singlefieldText(myForm,"nextVersion",services.ZettelFields.nextVersionZF.getLabel(),"",22)
				<br />	<br />
				@singlefieldText(myForm,"previousVersion",services.ZettelFields.previousVersionZF.getLabel(),"",23)
			}
			@accordionPanel(services.ZettelFields.identifiersHeaderZF.getLabel(),"identifier-section"){
				<br />
				@multifieldText(myForm,jsonMap,"urn",services.ZettelFields.urnZF.getLabel(),"",24)
				<br />
				@multifieldText(myForm,jsonMap,"doi",services.ZettelFields.doiZF.getLabel(),"",25)
				<br />
				@multifieldText(myForm,jsonMap,"isLike",services.ZettelFields.isLikeZF.getLabel(),"",26)
			}

			@if(controllers.ZettelController.callDataStreamEndpoint(ZettelHelper.getJsonMap(myForm).get("@id")+"", "ktbl")=="YES"){
			@accordionPanel("KTBL","ktbl-section"){
				<br />
				@singleSelect(myForm,"project_title","Project Title","",ResearchDataHelper.getProjectTitleMap(),27)
				<br />
				@singleSelect(myForm,"test_design","Test Design","",ResearchDataHelper.getTestDesignMap(),28)
				<br/>
				@singleSelect(myForm,"livestock_category","Livestock Category","",ResearchDataHelper.getLivestockCategoryMap(),29)
				<br/>
				@singleSelect(myForm,"livestock_production","Livestock Production","",ResearchDataHelper.getLivestockProductionMap(),30)
				<br/>
				@singleSelect(myForm,"ventilation_system","Ventilation System","select-ventilation",ResearchDataHelper.getVentilationSystemMap(),31)	
			   	 <br />
			   	@singleSelect(myForm,"housing_systems","Housing Systems","select-housing",ResearchDataHelper.getHousing_systemstMap(),32)	   
				<br />
				@multiselect(myForm,jsonMap,"additional_housing_systems","Additional Housing Systems","select-housing",ResearchDataHelper.getAdditionalHousingSystemsMap(),33)	
				<br />
				@multiselect(myForm,jsonMap,"emissions","Emissions","",ResearchDataHelper.getEmissionsMap(),35)	
				<br />
				@multiselect(myForm,jsonMap,"emission_reduction_methods","Emission Reduction Methods","",ResearchDataHelper.getEmissionReducingMethodsMap(),36)
				<br />
				@multiselect(myForm,jsonMap,"emi_measurement_techniques","Emission Measurement Techniques","",ResearchDataHelper.getEmiMeasurementTechniquesMap(),37)	
				}
			}else{
				<script>
  				document.addEventListener('DOMContentLoaded', function() {
    				var panel = document.querySelector('#ktbl-section');
    				panel.disabled = true;
    				panel.innerHTML = '';});
				</script>
			}
		
		}
		@if(myForm.hasErrors) {
		    <div class="alert alert-error">
		        <a class="close" data-dismiss="alert">x</a>
		       
		        @if(myForm.errors.size() > 0) {
		        <h3>Das Formular enth&auml;lt noch Fehler!</h3>
		        <table class="fieldErrors">
		        <tr><th>Feldname</th><th>Fehlermeldung</th></tr>
		            @for((key, value) <- ZettelHelper.sortErrorsForResearchData(myForm.errors)) {
		            	<tr>
		               		<td style="padding-right:10px;">@ZettelHelper.etikett.getLabel(ZettelHelper.getFieldWithoutIndex(key.toString())) </td>
		               		<td>
		                    @for(err <- value) {
		                        @err.message().toString()
		                    }
		                    </td>
		                 </tr>
		            }
		         </table>
		        } else {No error returned.}
		       
		    </div>
		}
		
		<!--  workaround: add rdftype=ResearchData via hidden form --> 
		<input type="hidden" name="rdftype[0]" value="http://hbz-nrw.de/regal#ResearchData" />
		<div class="form-group row">
			<div class="col-sm-offset-8 col-sm-4">
				<input id="cancel" class="cancel btn" type="button" value="Cancel" />
				<input type="submit" value="Save" class="btn btn-success" />
			</div>
		</div>



<script>

  var ready = (callback) => {
  if (document.readyState != "loading") callback();
  else document.addEventListener("DOMContentLoaded", callback);
}
 
ready(() => {

  markSelectedLivestockCategory();
  updateHousingSystemsOptions();
  updateAdditionalHousingOptions()
  document.getElementById('livestock_category').addEventListener('change', function() { 
  markSelectedLivestockCategory();
  updateAdditionalHousingOptions()
  
});

  document.getElementById('livestock_production').addEventListener('change', function() { 
  updateHousingSystemsOptions();
});


 
});

function markSelectedLivestockCategory() {
      var livestockCategory = document.getElementById('livestock_category').value;
      console.log("wert von livestock: "+livestockCategory);
     var livestockProductionOptions = document.getElementById('livestock_production').getElementsByTagName('option');


for (var j = 0; j < livestockProductionOptions.length; j++) {
        livestockProductionOptions[j].disabled = true; // Restliche Elemente deaktivieren
    }
	livestockProductionOptions[0].disabled=false;

    // Markierung basierend auf livestockCategory setzen
    if (livestockCategory === 'cattle') {
        for (var i = 0; i < 7; i++) {
		livestockProductionOptions[i].disabled=false;
        }
    } else if (livestockCategory === 'pig') {
        for (var i = 7; i < 10; i++) {
		livestockProductionOptions[i].disabled=false;

        }} else if (livestockCategory === 'chicken') {
            for (var i = 10; i < 13; i++) {
		livestockProductionOptions[i].disabled=false;

            }
        } else if (livestockCategory === 'turkey') {
            for (var i = 13; i < 15; i++) {
		livestockProductionOptions[i].disabled=false;

            }
        } else if (livestockCategory === 'duck') {
           livestockProductionOptions[livestockProductionOptions.length - 1].disabled=false;
        }

}

function updateHousingSystemsOptions() {
  const selectedLivestockProduction = document.getElementById('livestock_production').value;
  const housingSystemsOptions = document.getElementById('housing_systems').getElementsByTagName('option');
  const enabledOptions = getEnabledHousingOptions(selectedLivestockProduction);

  // Deaktiviere alle Optionen zunÃ¤chst
  for (let i = 0; i < housingSystemsOptions.length; i++) {
    housingSystemsOptions[i].disabled = true;
  }

  housingSystemsOptions[0].disabled = false;

  // Aktiviere die richtigen Optionen
  for (let i = 0; i < housingSystemsOptions.length; i++) {
    if (enabledOptions.has(housingSystemsOptions[i].value)) {
      housingSystemsOptions[i].disabled = false;
    }
  }
}

function getEnabledHousingOptions(selectedLivestockProduction) {
  const enabledOptions = new Set([
    'others',
    ...(selectedLivestockProduction === 'dairy_cattle_farming' || selectedLivestockProduction === 'young_cattle_farming' || selectedLivestockProduction === 'cattle_fattening'
      ? ['cubicle_h', 'loose_h_1_type_floor', 'loose_h_2_type_floor']
      : []),
    ...(selectedLivestockProduction === 'calf_raising'
      ? ['calf_boxes_h', 'igloo_or_hut_h', 'loose_h_1_type_floor', 'loose_h_2_type_floor']
      : []),
    ...(selectedLivestockProduction === 'calf_fattening' || selectedLivestockProduction === 'suckler_cow_farming'
      ? ['loose_h_1_type_floor', 'loose_h_2_type_floor']
      : []),
    ...(selectedLivestockProduction === 'pig_fattening' || selectedLivestockProduction === 'piglet_raising'
      ? ['1_area_pen', 'mult_area_pen']
      : []),
    ...(selectedLivestockProduction === 'piglet_production'
      ? ['farrow_area_1_area_pen', 'farrow_area_mult_area_pen', 'wait_mate_area_mult_area_pen']
      : []),
    ...(selectedLivestockProduction === 'laying_hen_farming'
      ? ['floor_h', 'floor_h_with_aviaries', 'mobile_h']
      : []),
    ...(selectedLivestockProduction === 'young_hen_farming'
      ? ['floor_h', 'floor_h_with_aviaries']
      : []),
    ...(selectedLivestockProduction === 'turkey_fattening' || selectedLivestockProduction === 'turkey_raising' || selectedLivestockProduction === 'duck_fattening'
      ? ['floor_h']
      : []),
  ]);
  return enabledOptions;
}

function updateAdditionalHousingOptions() {
  const livestockDropdown = document.getElementById('livestock_category');
  const housingDropdowns = document.querySelectorAll('[id^="additional_housing_systems"]');
  const selectedLivestock = livestockDropdown.value;
  const enabledAdditionalHousingOptions = getEnabledAdditionalHousingOptions(selectedLivestock);
  
  housingDropdowns.forEach((dropdown) => {
    const dropdownOptions = dropdown.getElementsByTagName('option');


    for (let i = 0; i < dropdownOptions.length; i++) {
      dropdownOptions[i].disabled = true;
    }
	dropdownOptions[0].disabled = false;

    for (let i = 0; i < dropdownOptions.length; i++) {
      if (enabledAdditionalHousingOptions.has(dropdownOptions[i].value)) {
        dropdownOptions[i].disabled = false;
      }
    }
  });
}

function getEnabledAdditionalHousingOptions(selectedLivestock) {
  const enabledOptions = new Set();

  if (['cattle', 'pig', 'chicken', 'turkey', 'duck'].includes(selectedLivestock)) {
    enabledOptions.add('solid_manure');
	enabledOptions.add('perforated_floor');
	enabledOptions.add('yard');
	enabledOptions.add('others');
  }

  if (['cattle', 'pig'].includes(selectedLivestock)) {
    enabledOptions.add('liquid_manure');
    enabledOptions.add('solid_floor');
    enabledOptions.add('pastures');
    enabledOptions.add('others');
	
  } 
  return enabledOptions;
}

</script>

}	
}
